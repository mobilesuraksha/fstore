<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Admin | F-Store HQ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #f1f5f9; }
        .sidebar-link { transition: all 0.2s; border-radius: 12px; font-weight: 600; font-size: 0.9rem; color: #64748b; display: flex; align-items: center; gap: 12px; padding: 14px 16px; }
        .sidebar-link:hover { background: #fff7ed; color: #ea580c; }
        .sidebar-link.active { background: #ea580c; color: white; box-shadow: 0 10px 15px -3px rgba(234, 88, 12, 0.3); }
        .slide-up { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        @media (max-width: 768px) { .sidebar { display: none; } .mobile-nav { display: flex; } .main-content { margin-left: 0; padding-bottom: 90px; } }
        @media (min-width: 769px) { .sidebar { display: block; } .mobile-nav { display: none; } .main-content { margin-left: 280px; } }
    </style>
</head>
<body class="text-slate-800 antialiased">

    <div id="login" class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-sm rounded-[2rem] p-8 text-center shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-orange-500 to-red-500"></div>
            <div class="w-20 h-20 bg-orange-50 rounded-full flex items-center justify-center mx-auto mb-6 text-orange-600 text-3xl font-black shadow-inner">A</div>
            <h2 class="text-4xl font-black mb-2 text-slate-800">Admin HQ</h2>
            <p class="text-xs text-slate-400 mb-8 font-bold uppercase tracking-widest">Master Control Panel</p>
            <input type="password" id="pin" placeholder="Enter PIN (1234)" class="w-full bg-slate-50 border-2 border-slate-200 p-4 rounded-xl text-center font-black text-xl outline-none mb-6 focus:border-orange-500 transition focus:ring-4 ring-orange-100">
            <button onclick="auth()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold shadow-xl hover:scale-[1.02] active:scale-95 transition">UNLOCK SYSTEM</button>
        </div>
    </div>

    <div id="sidebarPanel" class="sidebar fixed top-0 left-0 h-full w-[280px] bg-white border-r border-slate-200 z-40 hidden p-6">
        <div class="flex items-center gap-3 mb-12 px-2">
            <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-red-600 rounded-xl flex items-center justify-center text-white font-black italic text-xl shadow-lg">F</div>
            <div>
                <h1 class="text-2xl font-black italic tracking-tighter leading-none">F-Store</h1>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Master Panel</p>
            </div>
        </div>
        <nav class="space-y-3">
            <button onclick="view('dash')" id="nav-dash" class="sidebar-link active w-full"><i class="fas fa-chart-pie w-6"></i> Overview</button>
            <button onclick="view('ord')" id="nav-ord" class="sidebar-link w-full"><i class="fas fa-shopping-bag w-6"></i> Live Orders</button>
            <button onclick="view('shops')" id="nav-shops" class="sidebar-link w-full"><i class="fas fa-store w-6"></i> Shops & Menu</button>
            <button onclick="view('riders')" id="nav-riders" class="sidebar-link w-full"><i class="fas fa-motorcycle w-6"></i> Rider Fleet</button>
            <button onclick="view('req')" id="nav-req" class="sidebar-link w-full justify-between">
                <div class="flex items-center gap-3"><i class="fas fa-user-plus w-6"></i> Approvals</div>
                <span id="reqBadge" class="bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full hidden">0</span>
            </button>
            <button onclick="view('set')" id="nav-set" class="sidebar-link w-full"><i class="fas fa-cog w-6"></i> Settings</button>
        </nav>
        <div class="absolute bottom-6 left-6 right-6">
            <button onclick="location.reload()" class="w-full bg-slate-100 text-slate-500 py-3.5 rounded-xl font-bold text-xs hover:bg-red-50 hover:text-red-500 transition flex items-center justify-center gap-2"><i class="fas fa-power-off"></i> LOGOUT</button>
        </div>
    </div>

    <div id="mainPanel" class="main-content min-h-screen hidden p-4 md:p-8">
        
        <div id="view-dash" class="slide-up">
            <h2 class="text-3xl font-black mb-8 text-slate-800">Dashboard</h2>
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <div class="bg-white p-6 rounded-[1.5rem] border border-slate-100 shadow-sm relative overflow-hidden">
                    <div class="absolute right-0 top-0 w-24 h-24 bg-blue-50 rounded-full -mr-10 -mt-10"></div>
                    <p class="text-xs text-slate-400 font-bold uppercase relative z-10">Total Revenue</p>
                    <h3 class="text-4xl font-black text-slate-800 mt-2 relative z-10" id="dashRev">‚Çπ0</h3>
                </div>
                <div class="bg-white p-6 rounded-[1.5rem] border border-slate-100 shadow-sm relative overflow-hidden">
                    <div class="absolute right-0 top-0 w-24 h-24 bg-orange-50 rounded-full -mr-10 -mt-10"></div>
                    <p class="text-xs text-slate-400 font-bold uppercase relative z-10">Total Orders</p>
                    <h3 class="text-4xl font-black text-orange-600 mt-2 relative z-10" id="dashOrd">0</h3>
                </div>
                <div class="bg-white p-6 rounded-[1.5rem] border border-slate-100 shadow-sm">
                    <p class="text-xs text-slate-400 font-bold uppercase">Shops Active</p>
                    <h3 class="text-4xl font-black text-purple-600 mt-2" id="dashShops">0</h3>
                </div>
                <div class="bg-white p-6 rounded-[1.5rem] border border-slate-100 shadow-sm">
                    <p class="text-xs text-slate-400 font-bold uppercase">Riders</p>
                    <h3 class="text-4xl font-black text-green-600 mt-2" id="dashRiders">0</h3>
                </div>
            </div>
            
            <h3 class="font-bold text-xl mb-4 flex items-center gap-2"><i class="fas fa-history text-slate-400"></i> Recent Activity</h3>
            <div id="recentOrders" class="space-y-3 bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm min-h-[200px]"></div>
        </div>

        <div id="view-ord" class="hidden slide-up">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h2 class="text-3xl font-black">Order Management</h2>
                <div class="flex gap-2 bg-white p-1 rounded-xl border border-slate-200 shadow-sm">
                    <button onclick="filterOrders('All')" class="px-4 py-2 rounded-lg text-xs font-bold transition hover:bg-slate-100 bg-slate-900 text-white" id="f-All">All</button>
                    <button onclick="filterOrders('Pending')" class="px-4 py-2 rounded-lg text-xs font-bold transition hover:bg-slate-100 text-slate-500" id="f-Pending">Pending</button>
                    <button onclick="filterOrders('Out for Delivery')" class="px-4 py-2 rounded-lg text-xs font-bold transition hover:bg-slate-100 text-slate-500" id="f-Out">On Way</button>
                </div>
            </div>
            <div id="ordList" class="space-y-4 pb-20"></div>
        </div>

        <div id="view-shops" class="hidden slide-up">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-black">Shops & Menu</h2>
                <button onclick="document.getElementById('prodModal').classList.remove('hidden')" class="bg-orange-600 text-white px-5 py-3 rounded-xl text-xs font-bold shadow-lg shadow-orange-200 flex items-center gap-2 hover:scale-105 transition"><i class="fas fa-plus"></i> Add Item</button>
            </div>
            
            <div class="mb-8">
                <h3 class="font-bold text-slate-400 text-xs uppercase mb-3 ml-1">Registered Shops</h3>
                <div id="shopList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
            
            <div>
                <h3 class="font-bold text-slate-400 text-xs uppercase mb-3 ml-1">Global Menu & Inventory</h3>
                <div id="allProdList" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
            </div>
        </div>

        <div id="view-riders" class="hidden slide-up">
            <div class="grid lg:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-[2rem] border border-slate-100 h-fit shadow-sm">
                    <h3 class="font-black text-xl mb-1">Recruit Rider</h3>
                    <p class="text-xs text-slate-400 mb-6">Create new rider credentials</p>
                    <div class="space-y-4">
                        <input id="rName" placeholder="Full Name" class="w-full bg-slate-50 border-2 border-slate-100 p-3 rounded-xl text-sm font-bold outline-none focus:border-orange-500">
                        <input id="rPhone" type="number" placeholder="Mobile Number" class="w-full bg-slate-50 border-2 border-slate-100 p-3 rounded-xl text-sm font-bold outline-none focus:border-orange-500">
                        <input id="rPass" placeholder="Login Password" class="w-full bg-slate-50 border-2 border-slate-100 p-3 rounded-xl text-sm font-bold outline-none focus:border-orange-500">
                        <button id="addRiderBtn" class="w-full bg-blue-600 text-white py-3.5 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition">CREATE ACCOUNT</button>
                    </div>
                </div>
                <div class="lg:col-span-2">
                    <h3 class="font-black text-2xl mb-6">Active Fleet</h3>
                    <div id="ridList" class="grid md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </div>

        <div id="view-req" class="hidden slide-up">
            <h2 class="text-3xl font-black mb-6">Partner Requests</h2>
            <div id="reqList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <div id="view-set" class="hidden slide-up">
            <div class="max-w-md mx-auto bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-100 mt-10">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">‚öôÔ∏è</div>
                    <h2 class="text-2xl font-black">Global Settings</h2>
                </div>
                <div class="space-y-6">
                    <div>
                        <label class="text-xs font-black text-slate-500 uppercase ml-1 mb-1 block">Base Delivery Fee (‚Çπ)</label>
                        <input id="setBase" type="number" class="w-full bg-slate-50 border-2 border-slate-200 p-4 rounded-xl font-black text-xl text-slate-800 outline-none focus:border-orange-500">
                    </div>
                    <div>
                        <label class="text-xs font-black text-slate-500 uppercase ml-1 mb-1 block">Surge Multiplier (x1.0 = Normal)</label>
                        <input id="setSurge" type="number" step="0.1" class="w-full bg-slate-50 border-2 border-slate-200 p-4 rounded-xl font-black text-xl text-slate-800 outline-none focus:border-orange-500" value="1.0">
                    </div>
                    <button id="saveSettingsBtn" class="w-full bg-slate-900 text-white py-4 rounded-xl font-black shadow-lg hover:scale-105 transition">UPDATE SYSTEM</button>
                </div>
            </div>
        </div>
    </div>

    <div class="mobile-nav fixed bottom-0 w-full bg-white border-t border-slate-200 p-2 justify-around z-40 hidden pb-6 shadow-[0_-5px_10px_rgba(0,0,0,0.05)]">
        <button onclick="view('dash')" id="mob-dash" class="text-orange-600 flex flex-col items-center p-2 rounded-xl"><i class="fas fa-chart-pie text-xl mb-1"></i><span class="text-[10px] font-bold">Dash</span></button>
        <button onclick="view('ord')" id="mob-ord" class="text-slate-400 flex flex-col items-center p-2 rounded-xl"><i class="fas fa-shopping-bag text-xl mb-1"></i><span class="text-[10px] font-bold">Orders</span></button>
        <button onclick="view('shops')" id="mob-shops" class="text-slate-400 flex flex-col items-center p-2 rounded-xl"><i class="fas fa-store text-xl mb-1"></i><span class="text-[10px] font-bold">Shops</span></button>
        <button onclick="view('req')" id="mob-req" class="text-slate-400 flex flex-col items-center p-2 rounded-xl relative">
            <i class="fas fa-bell text-xl mb-1"></i><span class="text-[10px] font-bold">Reqs</span>
            <span id="mobReqBadge" class="absolute top-1 right-2 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white hidden"></span>
        </button>
    </div>

    <div id="editShopModal" class="fixed inset-0 bg-slate-900/80 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-[2rem] p-6 slide-up shadow-2xl">
            <h3 class="font-black text-xl mb-4">Edit Shop Details</h3>
            <input type="hidden" id="editShopId">
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Shop Name</label>
                    <input id="esName" class="w-full border-2 border-slate-100 p-3 rounded-xl text-sm font-bold outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Owner Mobile</label>
                    <input id="esPhone" class="w-full border-2 border-slate-100 p-3 rounded-xl text-sm font-bold outline-none focus:border-blue-500">
                </div>
                <button id="updateShopBtn" class="w-full bg-blue-600 text-white py-3.5 rounded-xl font-bold mt-2 shadow-lg">SAVE CHANGES</button>
                <button onclick="document.getElementById('editShopModal').classList.add('hidden')" class="w-full text-center text-xs font-bold text-slate-400 py-2">Cancel</button>
            </div>
        </div>
    </div>

    <div id="prodModal" class="fixed inset-0 bg-slate-900/80 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-[2rem] p-6 slide-up shadow-2xl">
            <h3 class="font-black text-xl mb-4">Add Menu Item</h3>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <input id="pName" placeholder="Product Name" class="col-span-2 border-2 border-slate-100 p-3 rounded-xl text-sm font-bold outline-none focus:border-orange-500">
                <input id="pPrice" type="number" placeholder="Price" class="border-2 border-slate-100 p-3 rounded-xl text-sm font-bold outline-none focus:border-orange-500">
                <input id="pQty" type="number" placeholder="Stock Qty (e.g. 50)" class="border-2 border-slate-100 p-3 rounded-xl text-sm font-bold outline-none focus:border-orange-500">
                <select id="pCat" class="border-2 border-slate-100 p-3 rounded-xl text-sm font-bold outline-none"><option>Food</option><option>Fashion</option><option>Mobile</option></select>
                <select id="pShop" class="col-span-2 border-2 border-slate-100 p-3 rounded-xl text-sm font-bold outline-none"><option value="">Select Shop</option></select>
                <div class="col-span-2 relative border-2 border-dashed border-slate-200 rounded-xl p-4 text-center">
                    <input type="file" id="pImgFile" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                    <span class="text-xs font-bold text-slate-400">Click to Upload Image</span>
                </div>
            </div>
            <button id="saveProdBtn" class="w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold shadow-lg">ADD TO DATABASE</button>
            <button onclick="document.getElementById('prodModal').classList.add('hidden')" class="w-full mt-3 text-center text-xs font-bold text-slate-400">Cancel</button>
        </div>
    </div>

    <div id="ordDetailModal" class="fixed inset-0 bg-slate-900/80 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-[2rem] p-6 slide-up shadow-2xl relative">
            <button onclick="document.getElementById('ordDetailModal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            <h3 class="font-black text-2xl mb-1">Order Details</h3>
            <p class="text-sm font-bold text-slate-500 mb-4" id="odId">#ID</p>
            
            <div class="bg-slate-50 p-4 rounded-xl mb-4 text-sm space-y-2 border border-slate-100">
                <p><strong>Customer:</strong> <span id="odCust"></span></p>
                <p><strong>Phone:</strong> <span id="odPhone"></span></p>
                <p><strong>Address:</strong> <span id="odAddr"></span></p>
                <div class="pt-2 border-t border-slate-200 mt-2">
                    <p class="text-xs text-slate-400 uppercase font-bold mb-1">Items</p>
                    <div id="odItems" class="font-mono text-xs"></div>
                </div>
            </div>

            <div class="flex gap-2">
                <a id="odMap" target="_blank" href="#" class="flex-1 bg-blue-50 text-blue-600 py-3 rounded-xl font-bold text-xs text-center border border-blue-100">VIEW ON MAP</a>
                <button id="odCancelBtn" class="flex-1 bg-red-50 text-red-600 py-3 rounded-xl font-bold text-xs border border-red-100">CANCEL ORDER</button>
            </div>
        </div>
    </div>

    <div id="editOrderModal" class="fixed inset-0 bg-slate-900/80 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-[2rem] p-6 slide-up shadow-2xl">
            <h3 class="font-black text-xl mb-4">Edit Order</h3>
            <input type="hidden" id="eoId">
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Status</label>
                    <select id="eoStatus" class="w-full border-2 border-slate-100 p-3 rounded-xl text-sm font-bold outline-none focus:border-blue-500">
                        <option>Pending</option><option>Approved</option><option>Preparing</option><option>Ready for Pickup</option>
                        <option>Accepted</option><option>Out for Delivery</option><option>Arrived</option><option>Delivered</option><option>Cancelled</option>
                    </select>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Rider Phone (Optional Override)</label>
                    <input id="eoRider" placeholder="Enter Mobile Number" class="w-full border-2 border-slate-100 p-3 rounded-xl text-sm font-bold outline-none focus:border-blue-500">
                </div>
                <button id="saveOrderChangesBtn" class="w-full bg-blue-600 text-white py-3.5 rounded-xl font-bold mt-2 shadow-lg">UPDATE ORDER</button>
                <button onclick="document.getElementById('editOrderModal').classList.add('hidden')" class="w-full text-center text-xs font-bold text-slate-400 py-2">Cancel</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, onSnapshot, query, where, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCwyzE9sdZZUU3dHUix23zEzFkGr2nNRyw", authDomain: "foodhub-8ae15.firebaseapp.com", projectId: "foodhub-8ae15", storageBucket: "foodhub-8ae15.firebasestorage.app", messagingSenderId: "274265160043", appId: "1:274265160043:web:81238fd424681e7f70342e" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let orders=[], riders=[], shops=[], products=[], reqs=[];
        let filterStatus = 'All';

        window.auth = () => {
            if(document.getElementById('pin').value === '1234'){ 
                document.getElementById('login').classList.add('hidden'); 
                document.getElementById('sidebarPanel').classList.remove('hidden');
                document.getElementById('mainPanel').classList.remove('hidden');
                document.querySelector('.mobile-nav').classList.remove('hidden');
                initListeners();
            } else alert("Wrong PIN"); 
        };

        function initListeners() {
            onSnapshot(collection(db, "orders"), (s) => { orders = s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(b.timestamp||0)-(a.timestamp||0)); renderDashboard(); renderOrders(); });
            
            // Fix: Refresh Orders when Riders load
            onSnapshot(collection(db, "riders"), (s) => { 
                riders = s.docs.map(d=>({id:d.id,...d.data()})); 
                renderRiders(); renderDashboard(); renderOrders();
            });
            
            onSnapshot(collection(db, "shops"), (s) => { 
                shops = s.docs.map(d=>({id:d.id,...d.data()})); 
                renderShops(); renderDashboard(); 
                document.getElementById('pShop').innerHTML = `<option value="">Select Shop</option>` + shops.map(s=>`<option value="${s.id}">${s.shopName}</option>`).join('');
            });
            onSnapshot(collection(db, "products"), (s) => { products = s.docs.map(d=>({id:d.id,...d.data()})); renderProducts(); });
            onSnapshot(collection(db, "shop_requests"), (s) => { 
                reqs = s.docs.map(d=>({id:d.id,...d.data()})); 
                renderReqs(); 
                let count = reqs.length;
                document.getElementById('reqBadge').innerText = count;
                document.getElementById('reqBadge').classList.toggle('hidden', count===0);
                document.getElementById('mobReqBadge').classList.toggle('hidden', count===0);
            });
            onSnapshot(doc(db, "settings", "global"), (s) => {
                if(s.exists()) {
                    let d = s.data();
                    document.getElementById('setBase').value = d.fee || 20;
                    document.getElementById('setSurge').value = d.surge || 1.0;
                }
            });
        }

        // --- DASHBOARD ---
        function renderDashboard() {
            document.getElementById('dashRev').innerText = '‚Çπ' + orders.filter(o=>o.status==='Delivered').reduce((a,b)=>a+(parseInt(b.total)||0), 0);
            document.getElementById('dashOrd').innerText = orders.length;
            document.getElementById('dashShops').innerText = shops.length;
            document.getElementById('dashRiders').innerText = riders.length;
            document.getElementById('recentOrders').innerHTML = orders.slice(0,5).map(o => `
                <div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-100">
                    <div><p class="font-bold text-xs text-slate-800">#${o.id.substr(0,5)} - ${o.customer.name}</p><p class="text-[10px] text-slate-400">${o.status}</p></div>
                    <span class="font-black text-xs">‚Çπ${o.total}</span>
                </div>`).join('');
        }

        // --- ORDERS ---
        window.filterOrders = (s) => { 
            filterStatus = s; 
            ['All','Pending','Out for Delivery'].forEach(x => {
                let btn = document.getElementById('f-'+(x === 'Out for Delivery' ? 'Out' : x));
                if(btn) {
                    if(s.includes(x) || (s==='All' && x==='All')) { btn.classList.add('bg-slate-900','text-white'); btn.classList.remove('text-slate-500'); }
                    else { btn.classList.remove('bg-slate-900','text-white'); btn.classList.add('text-slate-500'); }
                }
            });
            renderOrders(); 
        }

        function renderOrders() {
            let list = filterStatus === 'All' ? orders : orders.filter(o => o.status === filterStatus);
            document.getElementById('ordList').innerHTML = list.map(o => {
                let riderOpts = riders.map(r => `<option value="${r.phone}">${r.name}</option>`).join('');
                let statusColor = o.status==='Pending' ? 'text-red-600 bg-red-50 border-red-100' : (o.status==='Ready for Pickup' ? 'text-green-600 bg-green-50 border-green-100 animate-pulse' : 'text-blue-600 bg-blue-50 border-blue-100');
                
                // PAYMENT STATUS LOGIC
                let payStatus = '';
                if(o.paymentMethod === 'UPI') {
                    if(o.paymentVerified) payStatus = `<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold">PAID (UTR: ${o.utr})</span>`;
                    else payStatus = `<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-[10px] font-bold cursor-pointer hover:bg-yellow-200" onclick="window.verifyPay('${o.id}')">VERIFY UPI (${o.utr})</span>`;
                } else {
                    payStatus = `<span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-[10px] font-bold">COD</span>`;
                }

                let action = '';
                if(o.status==='Pending') action=`<button onclick="window.approveOrder('${o.id}')" class="w-full bg-red-500 text-white py-2.5 rounded-xl text-xs font-bold animate-pulse shadow-md hover:bg-red-600">APPROVE ORDER</button>`;
                else if(['Approved', 'Preparing', 'Accepted', 'Ready for Pickup'].includes(o.status)) {
                    action=`
                    <div class="flex gap-2">
                        <select id="asn-${o.id}" class="bg-slate-50 border p-2.5 rounded-xl text-xs w-full font-bold outline-none">
                            <option value="">${o.riderName ? 'Change Rider' : 'Assign Rider'}</option>
                            ${riderOpts}
                        </select>
                        <button onclick="window.assignRider('${o.id}')" class="bg-slate-900 text-white px-4 rounded-xl text-xs font-bold shadow-md">GO</button>
                    </div>`;
                }
                else action=`<div class="text-xs text-center font-bold text-slate-400 p-2.5 bg-slate-50 rounded-xl border border-slate-100">Status: ${o.status}</div>`;

                return `
                <div class="bg-white p-5 rounded-[1.5rem] border border-slate-100 shadow-sm flex flex-col md:flex-row gap-4 justify-between items-center relative overflow-hidden group hover:border-orange-100 transition">
                    <div class="w-full">
                        <div class="flex justify-between mb-2">
                            <div><span class="font-black text-slate-700">#${o.id.substr(0,5)}</span> <span class="px-2 py-1 rounded-lg text-[10px] font-bold border ${statusColor}">${o.status}</span></div>
                            <div>${payStatus}</div>
                        </div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-0.5">${shops.find(s=>s.id==o.shopId)?.shopName || 'Unknown Shop'}</p>
                        <p class="text-sm font-bold text-slate-800">${o.customer.name}</p>
                        <div class="flex items-center gap-2 mt-2">
                            <button onclick="window.showOrdDetail('${o.id}')" class="text-xs bg-slate-100 text-slate-600 px-3 py-1 rounded-lg font-bold hover:bg-slate-200"><i class="fas fa-eye"></i></button>
                            <button onclick="window.editOrder('${o.id}')" class="text-xs bg-blue-50 text-blue-600 px-3 py-1 rounded-lg font-bold hover:bg-blue-100"><i class="fas fa-pen"></i></button>
                            <button onclick="window.delOrd('${o.id}')" class="text-xs bg-red-50 text-red-600 px-3 py-1 rounded-lg font-bold hover:bg-red-100"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="w-full md:w-72 flex-shrink-0 z-10 bg-white p-1 rounded-xl">${action}</div>
                </div>`;
            }).join('');
        }

        // --- VERIFY PAYMENT ---
        window.verifyPay = async (id) => {
            if(confirm("Confirm UPI Payment Verified?")) {
                await updateDoc(doc(db, "orders", id), { paymentVerified: true });
                alert("Payment Verified! Rider will be notified.");
            }
        };

        // --- SHOPS ---
        function renderShops() {
            document.getElementById('shopList').innerHTML = shops.map(s => `
                <div class="bg-white p-5 rounded-[1.5rem] border border-slate-100 shadow-sm relative group hover:shadow-md transition">
                    <div class="flex justify-between items-start mb-2">
                        <div class="w-10 h-10 bg-purple-50 rounded-xl flex items-center justify-center text-purple-600 text-lg">üè™</div>
                        <div class="flex gap-1">
                            <button onclick="window.editShop('${s.id}')" class="w-8 h-8 rounded-full bg-slate-50 text-blue-500 hover:bg-blue-500 hover:text-white transition flex items-center justify-center"><i class="fas fa-pen text-xs"></i></button>
                            <button onclick="window.delShop('${s.id}')" class="w-8 h-8 rounded-full bg-slate-50 text-red-500 hover:bg-red-500 hover:text-white transition flex items-center justify-center"><i class="fas fa-trash text-xs"></i></button>
                        </div>
                    </div>
                    <h4 class="font-black text-lg text-slate-800 leading-tight mb-1">${s.shopName}</h4>
                    <p class="text-xs text-slate-500 font-bold">${s.owner} | ${s.phone}</p>
                    <p class="text-[10px] text-slate-400 mt-2 truncate">${s.location || 'No Location'}</p>
                </div>`).join('');
        }

        // --- RIDERS ---
        function renderRiders() {
            document.getElementById('ridList').innerHTML = riders.map(r => {
                let delivered = orders.filter(o=>o.riderPhone==r.phone && o.status=='Delivered');
                let cashHeld = delivered.reduce((a,b)=>a+(parseInt(b.total)||0), 0);
                
                return `
                <div class="bg-white p-5 rounded-[1.5rem] border border-slate-100 shadow-sm flex flex-col justify-between">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="font-black text-lg text-slate-800">${r.name}</h4>
                            <p class="text-xs text-slate-500 font-bold">${r.phone}</p>
                        </div>
                        <button onclick="window.delRider('${r.id}')" class="text-red-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="bg-slate-50 p-3 rounded-xl flex justify-between items-center">
                        <div>
                            <p class="text-[10px] text-slate-400 font-bold uppercase">Cash in Hand</p>
                            <p class="font-black text-lg text-green-600">‚Çπ${cashHeld}</p>
                        </div>
                        <button onclick="alert('Feature: Mark Cash Collected (Reset to 0) coming soon!')" class="text-[10px] font-bold bg-white border border-slate-200 px-3 py-1 rounded-lg text-slate-600">COLLECT</button>
                    </div>
                </div>`;
            }).join('');
        }

        // --- PRODUCTS (INVENTORY ADDED) ---
        window.renderProducts = () => { 
            document.getElementById('allProdList').innerHTML = products.map(p => {
                let inStock = p.inStock !== false; 
                let bgClass = inStock ? 'bg-white' : 'bg-red-50 opacity-75';
                let btnText = inStock ? 'In Stock' : 'Out of Stock';
                let btnColor = inStock ? 'text-green-600 bg-green-100' : 'text-red-600 bg-red-100';
                let qtyText = p.stock ? `(${p.stock} left)` : '';

                return `
                <div class="${bgClass} p-3 rounded-2xl border border-slate-100 relative text-center group hover:border-orange-200 transition">
                    <button onclick="window.delProd('${p.id}')" class="absolute top-1 right-1 w-6 h-6 bg-slate-100 text-slate-400 rounded-full flex items-center justify-center text-[10px] hover:bg-red-500 hover:text-white transition"><i class="fas fa-times"></i></button>
                    
                    <div class="w-full h-20 bg-slate-50 rounded-xl mb-2 overflow-hidden"><img src="${p.img}" class="w-full h-full object-cover"></div>
                    
                    <p class="font-bold text-xs truncate text-slate-800">${p.name}</p>
                    <p class="text-xs text-orange-600 font-black mb-2">‚Çπ${p.price} <span class="text-gray-400 font-normal">${qtyText}</span></p>
                    
                    <button onclick="window.toggleStock('${p.id}', ${inStock})" class="w-full py-1 rounded-lg text-[10px] font-bold ${btnColor}">
                        ${btnText} <i class="fas fa-exchange-alt ml-1"></i>
                    </button>
                </div>`;
            }).join(''); 
        }

        window.toggleStock = async (id, currentStatus) => {
            await updateDoc(doc(db, "products", id), { inStock: !currentStatus });
        };

        // --- REQUESTS ---
        function renderReqs() {
            document.getElementById('reqList').innerHTML = reqs.map(r => `
                <div class="bg-white p-6 rounded-[2rem] border-l-4 border-yellow-400 shadow-sm">
                    <div class="mb-4">
                        <h3 class="font-black text-xl text-slate-800">${r.shopName}</h3>
                        <p class="text-xs text-gray-500 font-bold">${r.owner} | ${r.phone}</p>
                        <p class="text-xs text-gray-400 mt-2 bg-slate-50 p-2 rounded-lg">${r.bio}</p>
                    </div>
                    <div class="flex gap-2 items-center">
                        <input id="pass-${r.id}" placeholder="Assign Password" class="bg-slate-50 border p-3 rounded-xl text-xs w-full font-bold outline-none">
                        <button onclick="window.approveReq('${r.id}')" class="bg-green-500 text-white w-10 h-10 rounded-xl font-bold flex-shrink-0 hover:bg-green-600"><i class="fas fa-check"></i></button>
                        <button onclick="window.delReq('${r.id}')" class="bg-red-500 text-white w-10 h-10 rounded-xl font-bold flex-shrink-0 hover:bg-red-600"><i class="fas fa-times"></i></button>
                    </div>
                </div>`).join('');
        }

        // --- ACTIONS ---
        window.approveOrder = async (id) => await updateDoc(doc(db, "orders", id), { status: 'Approved' });
        
        // Force Assign Logic
        window.assignRider = async (id) => {
            let rp = document.getElementById(`asn-${id}`).value;
            if(!rp) return alert("Please select a rider first.");
            let r = riders.find(x=>x.phone==rp);
            
            let o = orders.find(x=>x.id==id);
            let nextStatus = o.status;
            if(o.status === 'Pending' || o.status === 'Approved') nextStatus = 'Preparing';
            
            await updateDoc(doc(db, "orders", id), { 
                status: nextStatus,
                riderPhone: rp, 
                riderName: r.name 
            });
            alert("Rider Assigned & Notified!");
        }
        
        window.delOrd = async (id) => { if(confirm("Permanently Delete Order?")) await deleteDoc(doc(db, "orders", id)); };
        
        window.showOrdDetail = (id) => {
            let o = orders.find(x=>x.id==id);
            if(!o) return;
            document.getElementById('odId').innerText = "#" + o.id;
            document.getElementById('odCust').innerText = o.customer.name;
            document.getElementById('odPhone').innerText = o.customer.phone;
            document.getElementById('odAddr').innerText = o.customer.addr;
            document.getElementById('odItems').innerHTML = o.items.map(i=>`<div class="flex justify-between border-b border-dashed border-slate-200 py-1"><span>${i.qty}x ${i.name}</span><span>‚Çπ${i.price*i.qty}</span></div>`).join('') + `<div class="flex justify-between font-bold pt-2"><span>Total</span><span>‚Çπ${o.total}</span></div>`;
            document.getElementById('odMap').href = `https://www.google.com/maps/search/?api=1&query=${o.customer.lat},${o.customer.lng}`;
            document.getElementById('odCancelBtn').onclick = async () => { if(confirm("Cancel this order?")) { await updateDoc(doc(db,"orders",id),{status:'Cancelled'}); document.getElementById('ordDetailModal').classList.add('hidden'); }};
            document.getElementById('ordDetailModal').classList.remove('hidden');
        }

        // *** EDIT ORDER FUNCTIONS ***
        window.editOrder = (id) => {
            let o = orders.find(x => x.id === id);
            document.getElementById('eoId').value = id;
            document.getElementById('eoStatus').value = o.status;
            document.getElementById('eoRider').value = o.riderPhone || '';
            document.getElementById('editOrderModal').classList.remove('hidden');
        }

        document.getElementById('saveOrderChangesBtn').onclick = async () => {
            let id = document.getElementById('eoId').value;
            let st = document.getElementById('eoStatus').value;
            let rp = document.getElementById('eoRider').value;
            
            let data = { status: st };
            if(rp) data.riderPhone = rp;
            
            await updateDoc(doc(db, "orders", id), data);
            alert("Order Updated!");
            document.getElementById('editOrderModal').classList.add('hidden');
        }

        // Shops
        window.editShop = (id) => {
            let s = shops.find(x => x.id === id);
            document.getElementById('editShopId').value = id;
            document.getElementById('esName').value = s.shopName;
            document.getElementById('esPhone').value = s.phone;
            document.getElementById('editShopModal').classList.remove('hidden');
        };
        window.delShop = async (id) => { if(confirm("Delete Shop? This cannot be undone.")) await deleteDoc(doc(db, "shops", id)); };

        document.getElementById('updateShopBtn').onclick = async () => {
            let id = document.getElementById('editShopId').value;
            await updateDoc(doc(db, "shops", id), { shopName: document.getElementById('esName').value, phone: document.getElementById('esPhone').value });
            alert("Shop Updated!");
            document.getElementById('editShopModal').classList.add('hidden');
        };

        // Products
        window.delProd = async (id) => { if(confirm("Remove item?")) await deleteDoc(doc(db, "products", id)); };
        
        document.getElementById('saveProdBtn').onclick = () => {
            let n = document.getElementById('pName').value, pr = document.getElementById('pPrice').value, qty = document.getElementById('pQty').value, s = document.getElementById('pShop').value, c = document.getElementById('pCat').value, f = document.getElementById('pImgFile').files[0];
            if(!n || !f || !s) return alert("Fill all details & select shop");
            
            const r = new FileReader(); r.readAsDataURL(f);
            r.onload = async function() { 
                let btn = document.getElementById('saveProdBtn'); btn.innerText = "Saving...";
                await addDoc(collection(db,"products"), { shopId: s, name: n, price: pr, stock: parseInt(qty) || 0, cat: c, img: r.result, inStock: true }); 
                alert("Added"); document.getElementById('prodModal').classList.add('hidden'); 
                btn.innerText = "ADD TO DATABASE";
            }
        };

        // Riders
        document.getElementById('addRiderBtn').onclick = async () => {
            let n=document.getElementById('rName').value, p=document.getElementById('rPhone').value, ps=document.getElementById('rPass').value;
            if(n && p && ps) { await addDoc(collection(db, "riders"), { name: n, phone: p, pass: ps }); document.getElementById('rName').value=''; alert("Rider Added"); }
        };
        window.delRider = async (id) => { if(confirm("Remove Rider?")) await deleteDoc(doc(db, "riders", id)); };

        // Requests
        window.approveReq = async (id) => {
            let r = reqs.find(x => x.id == id);
            let p = document.getElementById(`pass-${id}`).value;
            if(!p) return alert("Assign a Password");
            await addDoc(collection(db, "shops"), { ...r, pass: p });
            await deleteDoc(doc(db, "shop_requests", id));
        };
        window.delReq = async (id) => await deleteDoc(doc(db, "shop_requests", id));

        // Settings
        document.getElementById('saveSettingsBtn').onclick = async () => {
            await setDoc(doc(db, "settings", "global"), { 
                fee: document.getElementById('setBase').value, 
                surge: document.getElementById('setSurge').value 
            });
            alert("Settings Saved");
        };

        // Navigation
        window.view = (v) => {
            ['dash','ord','shops','riders','req','set'].forEach(x => {
                document.getElementById('view-'+x).classList.add('hidden');
                let btn = document.getElementById('nav-'+x); if(btn) btn.classList.remove('active');
                let mBtn = document.getElementById('mob-'+x); if(mBtn) mBtn.classList.remove('text-orange-600');
            });
            document.getElementById('view-'+v).classList.remove('hidden');
            let btn = document.getElementById('nav-'+v); if(btn) btn.classList.add('active');
            let mBtn = document.getElementById('mob-'+v); if(mBtn) mBtn.classList.add('text-orange-600');
        };
    </script>
</body>
</html>